# ğŸš€ APIå®¢æˆ·ç«¯ç¼“å­˜ç­–ç•¥è¯¦ç»†è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®çš„APIå®¢æˆ·ç«¯(`src/lib/api-client.ts`)å®ç°äº†æ™ºèƒ½çš„åˆ†å±‚ç¼“å­˜ç³»ç»Ÿï¼Œæ ¹æ®ä¸åŒæ•°æ®ç±»å‹çš„ä¸šåŠ¡ç‰¹æ€§ï¼Œé‡‡ç”¨å·®å¼‚åŒ–çš„ç¼“å­˜ç­–ç•¥ï¼Œåœ¨ä¿è¯æ•°æ®æ–°é²œåº¦çš„åŒæ—¶æœ€å¤§åŒ–æ€§èƒ½ä¼˜åŒ–ã€‚

## ğŸ¯ ç¼“å­˜ç­–ç•¥è®¾è®¡åŸåˆ™

### 1. ä¸šåŠ¡å¯¼å‘çš„ç¼“å­˜æ—¶é—´
- **å®æ—¶æ€§è¦æ±‚é«˜**ï¼šé€šçŸ¥è®¡æ•°ç­‰å…³é”®æŒ‡æ ‡ï¼Œé‡‡ç”¨è¶…çŸ­æœŸç¼“å­˜(10ç§’)
- **ä¸­ç­‰æ›´æ–°é¢‘ç‡**ï¼šå¸–å­å†…å®¹ã€ç”¨æˆ·ç»Ÿè®¡ï¼Œé‡‡ç”¨çŸ­ä¸­æœŸç¼“å­˜(30-60ç§’)  
- **ä½é¢‘å˜åŒ–æ•°æ®**ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€è®¾ç½®é¡¹ï¼Œé‡‡ç”¨é•¿æœŸç¼“å­˜(5-10åˆ†é’Ÿ)

### 2. æ ‡ç­¾åŒ–ç¼“å­˜ç®¡ç†
- **posts**: å¸–å­ç›¸å…³æ•°æ®
- **users**: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯  
- **user-stats**: ç”¨æˆ·ç»Ÿè®¡æ•°æ®
- **current-user**: å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
- **notifications**: é€šçŸ¥ç›¸å…³æ•°æ®
- **notification-settings**: é€šçŸ¥è®¾ç½®
- **following**: å…³æ³¨å…³ç³»æ•°æ®
- **search**: æœç´¢ç»“æœ

### 3. å¤šç§ç¼“å­˜æ¨¡å¼
- **cache-first**: ç¼“å­˜ä¼˜å…ˆï¼Œé€‚åˆç›¸å¯¹ç¨³å®šçš„æ•°æ®
- **network-first**: ç½‘ç»œä¼˜å…ˆï¼Œç¡®ä¿æ•°æ®æ–°é²œåº¦
- **cache-only**: ä»…ä½¿ç”¨ç¼“å­˜ï¼Œç¦»çº¿æ¨¡å¼
- **network-only**: ä»…ç½‘ç»œè¯·æ±‚ï¼Œå†™æ“ä½œç­‰

## ğŸ“Š è¯¦ç»†ç¼“å­˜ç­–ç•¥è¡¨

| APIç±»åˆ« | ç«¯ç‚¹ç¤ºä¾‹ | TTL | æ¨¡å¼ | æ ‡ç­¾ | ä¸šåŠ¡è¯´æ˜ |
|---------|----------|-----|------|------|----------|
| **ğŸ” è®¤è¯ç›¸å…³** | `/auth/login` | - | network-only | - | ç™»å½•/æ³¨å†Œ/ç™»å‡ºï¼ŒçŠ¶æ€å˜æ›´æ“ä½œ |
| **ğŸ‘¤ å½“å‰ç”¨æˆ·** | `/users/me` | 300s | cache-first | current-user | ä¸ªäººä¿¡æ¯å˜åŒ–é¢‘ç‡ä½ |
| **ğŸ” å…¶ä»–ç”¨æˆ·** | `/users/{id}` | 600s | cache-first | users | ä»–äººåŸºæœ¬ä¿¡æ¯å¾ˆå°‘å˜åŒ– |
| **ğŸ“Š ç”¨æˆ·ç»Ÿè®¡** | `/users/{id}/stats` | 30s | cache-first | user-stats | å…³æ³¨æ•°ç­‰å¯èƒ½é¢‘ç¹å˜åŒ– |
| **ğŸ² æ¨èç”¨æˆ·** | `/users/random` | 120s | cache-first | users | æ¨èåˆ—è¡¨å¯çŸ­æœŸç¼“å­˜ |
| **ğŸ” ç”¨æˆ·æœç´¢** | `/users/search` | 300s | cache-first | users,search | æœç´¢ç»“æœç›¸å¯¹ç¨³å®š |
| **ğŸ‘¥ å…³æ³¨å…³ç³»** | `/users/{id}/followers` | 120s | cache-first | users | å…³æ³¨å…³ç³»å˜åŒ–è¾ƒæ…¢ |
| **ğŸ  å…¬å…±å¸–å­** | `/posts` | 60s | cache-first | posts | å¹³è¡¡æ–°é²œåº¦å’Œæ€§èƒ½ |
| **ğŸ‘¥ å…³æ³¨å¸–å­** | `/posts/following` | 30s | cache-first | posts,following | ä¸ªæ€§åŒ–å†…å®¹æ›´é¢‘ç¹æ›´æ–° |
| **ğŸ” æœç´¢å¸–å­** | `/posts/search` | 300s | cache-first | posts,search | æœç´¢ç»“æœå¯è¾ƒé•¿ç¼“å­˜ |
| **ğŸ“„ å¸–å­è¯¦æƒ…** | `/posts/{id}` | 300s | cache-first | posts | å•ä¸ªå¸–å­å†…å®¹ç›¸å¯¹ç¨³å®š |
| **ğŸ’¬ å¸–å­è¯„è®º** | `/posts/{id}/comments` | 60s | network-first | - | è¯„è®ºéœ€è¦è¾ƒæ–°é²œåº¦ |
| **ğŸ”” é€šçŸ¥åˆ—è¡¨** | `/notifications` | 30s | cache-first | notifications | é€šçŸ¥éœ€è¦ç›¸å¯¹åŠæ—¶æ›´æ–° |
| **ğŸ”¢ æœªè¯»è®¡æ•°** | `/notifications/unread-count` | 10s | network-first | notifications | å®æ—¶æ€§è¦æ±‚æœ€é«˜ |
| **âš™ï¸ é€šçŸ¥è®¾ç½®** | `/notifications/settings` | 300s | cache-first | notification-settings | è®¾ç½®å˜åŒ–é¢‘ç‡å¾ˆä½ |

## ğŸ”„ ç¼“å­˜å¤±æ•ˆç­–ç•¥

### è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶
```typescript
// å†™æ“ä½œåè‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
if (method !== 'GET') {
  if (endpoint.includes('/posts')) {
    this.invalidateByTags(['posts', 'user-stats']);  // å‘å¸–å½±å“ç»Ÿè®¡
  }
  if (endpoint.includes('/users') || endpoint.includes('/follow')) {
    this.invalidateByTags(['users', 'user-stats', 'current-user']); // ç”¨æˆ·æ“ä½œ
  }
  if (endpoint.includes('/notifications')) {
    this.invalidateByTags(['notifications']); // é€šçŸ¥æ“ä½œ
  }
}
```

### æ ‡ç­¾åŒ–æ‰¹é‡æ¸…é™¤
- **å‘å¸ƒå¸–å­**: æ¸…é™¤ `posts` + `user-stats`
- **å…³æ³¨æ“ä½œ**: æ¸…é™¤ `users` + `user-stats` + `current-user`  
- **é€šçŸ¥æ“ä½œ**: æ¸…é™¤ `notifications`

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§

### 1. å†…å­˜ç¼“å­˜
```typescript
private memoryCache: Map<string, { 
  data: any; 
  expires: number; 
  tags: string[] 
}>;
```

### 2. Next.jsé›†æˆ
```typescript
// æ·»åŠ  Next.js ç¼“å­˜é…ç½®
if (cacheConfig.revalidate) {
  fetchConfig.next = { revalidate: cacheConfig.revalidate };
}
```

### 3. æ™ºèƒ½ç¼“å­˜é”®
```typescript
private getCacheKey(endpoint: string, options?: ApiRequestOptions): string {
  // åŒ…å«æŸ¥è¯¢å‚æ•°çš„å®Œæ•´ç¼“å­˜é”®
}
```

## âš¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```typescript
// è‡ªåŠ¨åº”ç”¨ç¼“å­˜ç­–ç•¥
const posts = await apiClient.posts.getAll();
const user = await apiClient.users.getById(userId);
```

### è‡ªå®šä¹‰ç¼“å­˜
```typescript
// è¦†ç›–é»˜è®¤ç¼“å­˜é…ç½®
const posts = await apiClient.posts.getAll(1, 10, {
  cacheConfig: { ttl: 120, mode: 'network-first' }
});
```

### ç¼“å­˜ç®¡ç†
```typescript
// æ‰‹åŠ¨æ¸…é™¤ç‰¹å®šæ ‡ç­¾çš„ç¼“å­˜
apiClient.invalidateByTags(['posts']);
```

## ğŸ“ˆ ç›‘æ§ä¸è°ƒè¯•

### ç¼“å­˜å‘½ä¸­ç»Ÿè®¡
å¯ä»¥åœ¨å¼€å‘å·¥å…·ä¸­è§‚å¯Ÿåˆ°ï¼š
- ç¼“å­˜å‘½ä¸­ï¼šå¿«é€Ÿå“åº”(é€šå¸¸<10ms)
- ç½‘ç»œè¯·æ±‚ï¼šè¾ƒæ…¢å“åº”(å‡ ç™¾åˆ°å‡ åƒms)

### ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ
æ¯ä¸ªç¼“å­˜é¡¹åŒ…å«ï¼š
- `data`: ç¼“å­˜çš„å“åº”æ•°æ®
- `expires`: è¿‡æœŸæ—¶é—´æˆ³  
- `tags`: å…³è”çš„æ ‡ç­¾åˆ—è¡¨

## ğŸ¯ æœ€ä½³å®è·µ

1. **è¯»å¤šå†™å°‘çš„æ•°æ®**: ä½¿ç”¨è¾ƒé•¿TTL + cache-first
2. **å®æ—¶æ€§è¦æ±‚é«˜**: ä½¿ç”¨çŸ­TTL + network-first  
3. **å†™æ“ä½œ**: ä½¿ç”¨network-onlyï¼Œå¹¶æ¸…é™¤ç›¸å…³ç¼“å­˜
4. **æœç´¢ç»“æœ**: å¯ä»¥ä½¿ç”¨è¾ƒé•¿TTLï¼Œå‡å°‘é‡å¤æœç´¢å¼€é”€
5. **ç”¨æˆ·äº¤äº’**: å…³æ³¨ã€ç‚¹èµç­‰æ“ä½œç«‹å³æ›´æ–°ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒ

## ğŸ”§ é…ç½®è°ƒä¼˜

æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥è°ƒæ•´ï¼š
- **TTLå€¼**: æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡å¾®è°ƒ
- **ç¼“å­˜æ¨¡å¼**: åœ¨æ€§èƒ½å’Œæ–°é²œåº¦é—´å¹³è¡¡
- **æ ‡ç­¾ç­–ç•¥**: ä¼˜åŒ–ç¼“å­˜å¤±æ•ˆçš„é¢—ç²’åº¦

è¿™å¥—ç¼“å­˜ç­–ç•¥æ˜¾è‘—æå‡äº†åº”ç”¨æ€§èƒ½ï¼ŒåŒæ—¶ä¿è¯äº†æ•°æ®çš„å‡†ç¡®æ€§å’Œç”¨æˆ·ä½“éªŒçš„æµç•…æ€§ã€‚
