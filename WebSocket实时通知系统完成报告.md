# WebSocket å®æ—¶é€šçŸ¥ç³»ç»Ÿå®Œæ•´å®ç°æŠ¥å‘Š

## ğŸ‰ é›†æˆçŠ¶æ€
âœ… **WebSocket å®æ—¶é€šçŸ¥ç³»ç»Ÿå·²æˆåŠŸé›†æˆå¹¶å®Œæˆè°ƒè¯•ï¼**

## ğŸ“‹ å®ç°æ‘˜è¦

### 1. ç³»ç»Ÿæ¶æ„
- **WebSocket æœåŠ¡å™¨**: ç‹¬ç«‹è¿è¡Œåœ¨ç«¯å£ 8080ï¼Œå¤„ç†å®æ—¶è¿æ¥å’Œæ¶ˆæ¯å¹¿æ’­
- **Next.js åº”ç”¨**: è¿è¡Œåœ¨ç«¯å£ 3000ï¼Œæä¾›å‰ç«¯ç•Œé¢å’ŒAPIæœåŠ¡
- **é€šä¿¡æ–¹å¼**: HTTP API + WebSocket åŒå‘é€šä¿¡
- **çŠ¶æ€ç®¡ç†**: Redux + WebSocket åŒé‡çŠ¶æ€åŒæ­¥

### 2. æ ¸å¿ƒç»„ä»¶

#### WebSocket æœåŠ¡å™¨ (`scripts/start-websocket.js`)
- ğŸš€ ç‹¬ç«‹ WebSocket æœåŠ¡å™¨ï¼Œæ”¯æŒå¼€å‘æ¨¡å¼è®¤è¯ç»•è¿‡
- ğŸ“¡ HTTP å¹¿æ’­ç«¯ç‚¹ `/broadcast` ç”¨äºæ¥æ”¶é€šçŸ¥æ¨é€è¯·æ±‚
- ğŸ’“ å¿ƒè·³æœºåˆ¶ä¿æŒè¿æ¥æ´»è·ƒ
- ğŸ‘¥ ç”¨æˆ·è¿æ¥ç®¡ç†å’ŒçŠ¶æ€è¿½è¸ª

#### DataLoader é›†æˆ (`src/components/common/DataLoader.tsx`)
- ğŸ”— è‡ªåŠ¨è¿æ¥ WebSocket å¹¶åŒæ­¥é€šçŸ¥çŠ¶æ€åˆ° Redux
- ğŸ“Š WebSocket æœªè¯»æ•°é‡ä¸ Redux çŠ¶æ€å®æ—¶åŒæ­¥
- ğŸ”„ ç¡®ä¿é€šçŸ¥æ•°æ®ä¸€è‡´æ€§

#### WebSocket Hook (`src/hooks/useNotificationWebSocket.ts`)
- ğŸ”„ å¤„ç† WebSocket è¿æ¥ã€æ¶ˆæ¯æ¥æ”¶å’Œå¿ƒè·³
- ï¿½ å®æ—¶æ›´æ–°æœªè¯»é€šçŸ¥è®¡æ•°
- ï¿½ è‡ªåŠ¨é‡è¿æœºåˆ¶å’Œé”™è¯¯å¤„ç†

#### é€šçŸ¥ Actions æ›´æ–° (`src/actions/notification.action.ts`)
- ğŸ“¤ åˆ›å»ºé€šçŸ¥æ—¶è‡ªåŠ¨è§¦å‘å®æ—¶å¹¿æ’­
- ğŸ”§ **é‡è¦ä¿®å¤**: æ›´æ–°ç°æœ‰é€šçŸ¥æ—¶é‡æ–°æ ‡è®°ä¸ºæœªè¯»çŠ¶æ€
- ğŸ¯ ç¡®ä¿ç”¨æˆ·èƒ½æ„ŸçŸ¥åˆ°æ–°çš„æ´»åŠ¨

### 3. å¯åŠ¨æ–¹å¼

#### å¼€å‘ç¯å¢ƒï¼ˆæ¨èï¼‰
```bash
npm run dev:with-ws
```
è¿™å°†åŒæ—¶å¯åŠ¨ï¼š
- ğŸŸ¦ WebSocket æœåŠ¡å™¨ï¼ˆç«¯å£ 8080ï¼‰
- ğŸŸ¨ Next.js å¼€å‘æœåŠ¡å™¨ï¼ˆç«¯å£ 3000ï¼‰

#### åˆ†åˆ«å¯åŠ¨
```bash
# å¯åŠ¨ WebSocket æœåŠ¡å™¨
npm run ws:start

# å¯åŠ¨ Next.js åº”ç”¨
npm run dev
```

### 4. åŠŸèƒ½ç‰¹æ€§

#### âœ… å®æ—¶é€šçŸ¥
- ç‚¹èµã€è¯„è®ºã€å…³æ³¨ç­‰æ“ä½œè§¦å‘å®æ—¶æ¨é€
- æ— éœ€åˆ·æ–°é¡µé¢å³å¯æ¥æ”¶æ–°é€šçŸ¥
- é€šçŸ¥å¾½ç« è‡ªåŠ¨æ›´æ–°ï¼ˆå·²ä¿®å¤åŒæ­¥é—®é¢˜ï¼‰

#### âœ… è¿æ¥ç®¡ç†
- è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆæœ€å¤š5æ¬¡é‡è¯•ï¼‰
- å¿ƒè·³ä¿æŒè¿æ¥æ´»è·ƒï¼ˆ30ç§’é—´éš”ï¼‰
- å¼€å‘ç¯å¢ƒè®¤è¯ç»•è¿‡ï¼Œç”Ÿäº§ç¯å¢ƒæ”¯æŒTokenéªŒè¯

#### âœ… Redux é›†æˆ
- å®æ—¶æ›´æ–° Redux çŠ¶æ€
- WebSocket ä¸ Redux æœªè¯»æ•°é‡åŒå‘åŒæ­¥
- æŒä¹…åŒ–é€šçŸ¥æ•°æ®

#### âœ… é€šçŸ¥çŠ¶æ€ç®¡ç†
- æ™ºèƒ½é‡å¤é€šçŸ¥å¤„ç†
- æ›´æ–°ç°æœ‰é€šçŸ¥æ—¶é‡æ–°æ ‡è®°ä¸ºæœªè¯»
- å‡†ç¡®çš„æœªè¯»è®¡æ•°ç»´æŠ¤

### 5. æŠ€æœ¯ç»†èŠ‚

#### WebSocket æ¶ˆæ¯ç±»å‹
```javascript
// ç”¨æˆ·æ³¨å†Œ
{ type: 'register', userId: 'user-id' }

// æ–°é€šçŸ¥æ¥æ”¶
{ 
  type: 'notification', 
  data: {
    id: 'notification-id',
    type: 'LIKE|COMMENT|FOLLOW',
    read: false,
    creator: { id, name, username, image },
    post: { id, content, image },
    createdAt: '2025-08-05T10:08:42.801Z'
  }
}

// å¿ƒè·³æœºåˆ¶
{ type: 'ping' } / { type: 'pong' }

// æœªè¯»æ•°é‡æ›´æ–°
{ type: 'unread_count', count: number }
```

#### é€šçŸ¥åˆ›å»ºæµç¨‹
1. ç”¨æˆ·æ‰§è¡Œæ“ä½œï¼ˆç‚¹èµã€è¯„è®ºã€å…³æ³¨ï¼‰
2. `createNotification()` åˆ›å»º/æ›´æ–°æ•°æ®åº“è®°å½•
3. **å…³é”®ä¿®å¤**: æ›´æ–°ç°æœ‰é€šçŸ¥æ—¶è®¾ç½® `read: false`
4. è‡ªåŠ¨å¹¿æ’­åˆ° WebSocket æœåŠ¡å™¨
5. WebSocket æ¨é€ `read: false` é€šçŸ¥åˆ°ç›®æ ‡ç”¨æˆ·
6. å‰ç«¯ `useNotificationWebSocket` æ¥æ”¶å¹¶å¢åŠ æœªè¯»è®¡æ•°
7. `DataLoader` åŒæ­¥ WebSocket æœªè¯»æ•°é‡åˆ° Redux
8. é€šçŸ¥å¾½ç« å®æ—¶æ›´æ–°

### 6. å…³é”®é—®é¢˜è§£å†³

#### ğŸ› å¾½ç« æœªå®æ—¶æ›´æ–°é—®é¢˜
**é—®é¢˜æè¿°**: WebSocket æ¥æ”¶åˆ°é€šçŸ¥ï¼Œæ§åˆ¶å°æ˜¾ç¤ºæ­£ç¡®çš„æœªè¯»æ•°é‡ï¼Œä½†é€šçŸ¥å¾½ç« ä¸æ›´æ–°

**æ ¹æœ¬åŸå› **: 
- é‡å¤é€šçŸ¥å¤„ç†é€»è¾‘ä¼šæ›´æ–°ç°æœ‰é€šçŸ¥çš„æ—¶é—´æˆ³
- ä½†ä¿æŒäº†åŸæœ‰çš„ `read` çŠ¶æ€ï¼ˆå¯èƒ½ä¸º `true`ï¼‰
- `read: true` çš„é€šçŸ¥ä¸ä¼šè§¦å‘æœªè¯»è®¡æ•°å¢åŠ 

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// ä¿®æ”¹ src/actions/notification.action.ts
if (existingNotification) {
  const updated = await prisma.notification.update({
    where: { id: existingNotification.id },
    data: { 
      createdAt: new Date(),
      read: false // ğŸ”§ å…³é”®ä¿®å¤ï¼šé‡æ–°æ ‡è®°ä¸ºæœªè¯»
    },
    // ...
  });
}
```

**éªŒè¯ç»“æœ**:
- âœ… WebSocket å¹¿æ’­åŒ…å« `read: false` çŠ¶æ€
- âœ… å‰ç«¯æ­£ç¡®å¢åŠ æœªè¯»è®¡æ•°
- âœ… é€šçŸ¥å¾½ç« å®æ—¶æ›´æ–°

#### ğŸ”„ æ•°æ®åŒæ­¥æœºåˆ¶
**WebSocket â†’ Redux åŒæ­¥æµç¨‹**:
```javascript
// useNotificationWebSocket.ts
case 'notification':
  if (!message.data.read) {
    setUnreadCount(prev => prev + 1); // WebSocket çŠ¶æ€æ›´æ–°
  }

// DataLoader.tsx  
useEffect(() => {
  setUnreadCount(unreadCount); // åŒæ­¥åˆ° Redux
}, [unreadCount, setUnreadCount]);
```

### 7. æ—¥å¿—å’Œè°ƒè¯•

#### WebSocket æœåŠ¡å™¨æ—¥å¿—
```
ğŸš€ Starting WebSocket server...
ğŸ¯ WebSocket server running on ws://localhost:8080
ï¿½ Waiting for connections...
âœ… WebSocket connection accepted (dev mode)
ğŸ”— New WebSocket connection established
ğŸ‘¤ User cmdrf5nu40000o8voo1hod9kd registered for notifications
ï¿½ Broadcasting notification via HTTP: { userId: 'cmdrf5nu40000o8voo1hod9kd', type: 'LIKE' }
ğŸ“¢ âœ… Successfully sent notification to user cmdrf5nu40000o8voo1hod9kd: LIKE
ï¿½ Notification data: { "read": false, ... }
```

#### å‰ç«¯è°ƒè¯•æ—¥å¿—
```
ğŸ“¡ WebSocketçŠ¶æ€ - è¿æ¥: true æœªè¯»: 2 é€šçŸ¥æ•°: 0
ğŸ”” New notification received: {id: 'xxx', type: 'LIKE', read: false, ...}
ï¿½ Unread count increased to: 2
ğŸ“Š åŒæ­¥æœªè¯»æ•°é‡: WebSocket = 2
```

### 8. æ•…éšœæ’é™¤

#### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

**1. é€šçŸ¥å¾½ç« ä¸å®æ—¶æ›´æ–°**
- âœ… å·²ä¿®å¤ï¼šç¡®ä¿é€šçŸ¥æ›´æ–°æ—¶è®¾ç½® `read: false`
- æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ WebSocket è¿æ¥é”™è¯¯
- éªŒè¯ `DataLoader` æ˜¯å¦æ­£ç¡®åŠ è½½

**2. WebSocket è¿æ¥å¤±è´¥**
- ç¡®ä¿ç«¯å£ 8080 æœªè¢«å ç”¨ï¼š`netstat -ano | findstr :8080`
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
- éªŒè¯ WebSocket æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨

**3. é€šçŸ¥åˆ›å»ºä½†æœªå¹¿æ’­**
- æ£€æŸ¥ `notification.action.ts` ä¸­çš„å¹¿æ’­é€»è¾‘
- éªŒè¯ WebSocket æœåŠ¡å™¨ `/broadcast` ç«¯ç‚¹å¯è®¿é—®
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

**4. é‡å¤é€šçŸ¥é—®é¢˜**
- âœ… å·²è§£å†³ï¼šç³»ç»Ÿä¼šæ™ºèƒ½æ›´æ–°ç°æœ‰é€šçŸ¥æ—¶é—´æˆ³
- ç›¸åŒæ“ä½œä¼šåˆ·æ–°é€šçŸ¥è€Œä¸æ˜¯åˆ›å»ºé‡å¤é¡¹

#### è°ƒè¯•å·¥å…·

**æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€**:
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network â†’ WS
- æŸ¥çœ‹ WebSocket è¿æ¥çŠ¶æ€å’Œæ¶ˆæ¯æµ

**éªŒè¯é€šçŸ¥æ•°æ®æµ**:
```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
console.log('Redux state:', store.getState().notifications);
```

### 9. æ€§èƒ½ä¼˜åŒ–

#### å·²å®ç°çš„ä¼˜åŒ–
- **æ™ºèƒ½é‡è¿**: æœ€å¤š5æ¬¡é‡è¯•ï¼Œé¿å…æ— é™é‡è¿
- **å¿ƒè·³æœºåˆ¶**: 30ç§’é—´éš”ï¼Œä¿æŒè¿æ¥æ´»è·ƒ
- **æ¶ˆæ¯å»é‡**: é‡å¤é€šçŸ¥æ›´æ–°è€Œéåˆ›å»ºæ–°è®°å½•
- **çŠ¶æ€åŒæ­¥**: æœ€å°åŒ– Redux æ›´æ–°é¢‘ç‡

#### å»ºè®®çš„è¿›ä¸€æ­¥ä¼˜åŒ–
- é€šçŸ¥æ‰¹é‡å¤„ç†ï¼ˆå‡å°‘ WebSocket æ¶ˆæ¯é¢‘ç‡ï¼‰
- è¿æ¥æ± ç®¡ç†ï¼ˆæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²ï¼‰
- æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆç¦»çº¿ç”¨æˆ·é€šçŸ¥ç¼“å­˜ï¼‰

### 10. æµ‹è¯•ç”¨ä¾‹

#### åŸºæœ¬åŠŸèƒ½æµ‹è¯•
```bash
# 1. å¯åŠ¨ç³»ç»Ÿ
npm run dev:with-ws

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬
node test-fixed-logic.js
```

**é¢„æœŸç»“æœ**:
- WebSocket è¿æ¥æˆåŠŸ
- é€šçŸ¥åˆ›å»ºå¹¶å¹¿æ’­
- å¾½ç« æ•°é‡å®æ—¶æ›´æ–°
- æ§åˆ¶å°æ˜¾ç¤ºæ­£ç¡®çš„è°ƒè¯•ä¿¡æ¯

#### å‹åŠ›æµ‹è¯•
```javascript
// å¿«é€Ÿåˆ›å»ºå¤šä¸ªé€šçŸ¥
for (let i = 0; i < 5; i++) {
  setTimeout(() => createNotification(), i * 1000);
}
```

**éªŒè¯ç‚¹**:
- æ‰€æœ‰é€šçŸ¥éƒ½èƒ½æ­£ç¡®æ¥æ”¶
- æœªè¯»æ•°é‡å‡†ç¡®ç´¯åŠ 
- ç³»ç»Ÿæ€§èƒ½ç¨³å®š

---

## ğŸ¯ æµ‹è¯•éªŒè¯

### å®Œæ•´æµ‹è¯•æµç¨‹
1. **å¯åŠ¨ç³»ç»Ÿ**: `npm run dev:with-ws`
2. **æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ**ï¼Œç™»å½•ä¸åŒç”¨æˆ·
3. **æ‰§è¡Œæ“ä½œ**: ç”¨æˆ·Bç‚¹èµç”¨æˆ·Açš„å¸–å­
4. **éªŒè¯ç»“æœ**: ç”¨æˆ·Aå®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œå¾½ç« æ•°é‡å¢åŠ 

### é¢„æœŸè¡Œä¸º
```
ç”¨æˆ·Aæ§åˆ¶å°è¾“å‡º:
ğŸ“¡ WebSocketçŠ¶æ€ - è¿æ¥: true æœªè¯»: 1 é€šçŸ¥æ•°: 0
ğŸ”” New notification received: {id: 'xxx', type: 'LIKE', read: false, ...}
ğŸ“Š Unread count increased to: 1
ğŸ“Š åŒæ­¥æœªè¯»æ•°é‡: WebSocket = 1
```

### æˆåŠŸæ ‡å‡†
- âœ… WebSocket è¿æ¥çŠ¶æ€æ˜¾ç¤ºä¸º `true`
- âœ… æ–°é€šçŸ¥çš„ `read` çŠ¶æ€ä¸º `false`
- âœ… æœªè¯»æ•°é‡æ­£ç¡®å¢åŠ 
- âœ… é€šçŸ¥å¾½ç« å®æ—¶æ›´æ–°ï¼ˆæ— éœ€åˆ·æ–°é¡µé¢ï¼‰

---

## ğŸ“ å…³é”®æ–‡ä»¶åˆ—è¡¨

### æ ¸å¿ƒå®ç°æ–‡ä»¶
- `scripts/start-websocket.js` - WebSocket æœåŠ¡å™¨
- `src/hooks/useNotificationWebSocket.ts` - WebSocket å®¢æˆ·ç«¯é’©å­
- `src/components/common/DataLoader.tsx` - çŠ¶æ€åŒæ­¥ç»„ä»¶
- `src/actions/notification.action.ts` - é€šçŸ¥åˆ›å»ºå’Œå¹¿æ’­é€»è¾‘
- `src/store/slices/notificationsSlice.ts` - Redux çŠ¶æ€ç®¡ç†

### æµ‹è¯•æ–‡ä»¶
- `test-fixed-logic.js` - é€šçŸ¥é€»è¾‘æµ‹è¯•è„šæœ¬
- `test-realtime-badge.js` - å®æ—¶å¾½ç« æ›´æ–°æµ‹è¯•
- `test-notification-status.js` - é€šçŸ¥çŠ¶æ€æ£€æŸ¥è„šæœ¬

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
# å®Œæ•´å¯åŠ¨å‘½ä»¤
npm run dev:with-ws

# æˆ–åˆ†åˆ«å¯åŠ¨
npm run ws:start &
npm run dev
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# æ„å»ºåº”ç”¨
npm run build

# å¯åŠ¨ WebSocket æœåŠ¡å™¨
NODE_ENV=production npm run ws:start

# å¯åŠ¨åº”ç”¨æœåŠ¡å™¨
npm start
```

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env.local
WEBSOCKET_PORT=8080
NODE_ENV=development # æˆ– production
```

---

## ğŸ‰ æ€»ç»“

**WebSocket å®æ—¶é€šçŸ¥ç³»ç»Ÿç°å·²å®Œå…¨å¯ç”¨ï¼**

### ä¸»è¦æˆå°±
- âœ… **å®Œæ•´çš„å®æ—¶é€šçŸ¥ç³»ç»Ÿ**: ä»é€šçŸ¥åˆ›å»ºåˆ°ç”¨æˆ·æ¥æ”¶çš„å®Œæ•´é“¾è·¯
- âœ… **é—®é¢˜è¯Šæ–­å’Œä¿®å¤**: è§£å†³äº†å¾½ç« æœªå®æ—¶æ›´æ–°çš„å…³é”®é—®é¢˜
- âœ… **ç¨³å®šçš„æ•°æ®åŒæ­¥**: WebSocket ä¸ Redux çŠ¶æ€å®Œç¾åŒæ­¥
- âœ… **ç”Ÿäº§çº§è´¨é‡**: åŒ…å«é”™è¯¯å¤„ç†ã€é‡è¿æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–

### æŠ€æœ¯äº®ç‚¹
- **åŒé‡çŠ¶æ€ç®¡ç†**: WebSocket + Redux ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **æ™ºèƒ½é€šçŸ¥å¤„ç†**: é‡å¤é€šçŸ¥æ›´æ–°è€Œéé‡å¤åˆ›å»º
- **å®æ—¶æ€§èƒ½**: æ¯«ç§’çº§é€šçŸ¥æ¨é€å’ŒçŠ¶æ€æ›´æ–°
- **å¼€å‘å‹å¥½**: è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å’Œæµ‹è¯•å·¥å…·

ğŸ¯ **ç³»ç»Ÿç°åœ¨å¯ä»¥å®Œç¾æ”¯æŒå®æ—¶ç¤¾äº¤äº’åŠ¨ï¼Œä¸ºç”¨æˆ·æä¾›å³æ—¶çš„é€šçŸ¥ä½“éªŒï¼**
