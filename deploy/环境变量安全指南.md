# 📋 环境变量配置指南

## 🔒 为什么 .env 文件不能上传到 GitHub？

环境变量文件包含敏感信息：
- 数据库密码
- API 密钥（如 UploadThing Secret）
- JWT 密钥
- 第三方服务凭证

上传到公开仓库会造成**严重安全风险**！

## 🛠️ 解决方案

### ✅ 方案一：使用模板文件（推荐）

#### 1. 创建模板文件
在项目中创建 `.env.example` 或 `.env.template`：

```bash
# .env.example - 可以安全上传到 GitHub
NODE_ENV=production
PORT=3000
NEXT_PUBLIC_APP_URL=https://yourdomain.com
NEXTAUTH_URL=https://yourdomain.com
NEXTAUTH_SECRET=your-32-character-secret-here
DATABASE_URL=postgresql://username:password@localhost:5432/database
UPLOADTHING_SECRET=sk_live_your_secret_here
UPLOADTHING_APP_ID=your_app_id_here
```

#### 2. 部署时复制并配置
```bash
# 在服务器执行
cp .env.example .env.production
vim .env.production  # 填入真实值
```

### ✅ 方案二：部署脚本自动生成

我们的部署脚本会自动生成 `.env.production` 文件，询问您输入真实配置。

### ✅ 方案三：安全存储服务

#### GitHub Secrets（CI/CD 部署）
```yaml
# .github/workflows/deploy.yml
env:
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  UPLOADTHING_SECRET: ${{ secrets.UPLOADTHING_SECRET }}
```

#### 阿里云密钥管理服务
- 使用阿里云 KMS 存储敏感配置
- 运行时动态获取

## 🚀 推荐的部署流程

### 步骤1：本地开发
```bash
# 本地使用 .env.local（不上传）
cp .env.example .env.local
# 填入开发环境配置
```

### 步骤2：版本控制
```bash
# 确保 .gitignore 包含
echo ".env*" >> .gitignore
echo "!.env.example" >> .gitignore

# 只上传模板文件
git add .env.example
git commit -m "add env template"
```

### 步骤3：服务器部署
```bash
# 方法A：手动配置
cp .env.example .env.production
vim .env.production

# 方法B：使用我们的一键脚本（会询问并生成）
./deploy/quick-deploy.sh
```

## 🔑 重要配置项说明

### NEXTAUTH_SECRET
```bash
# 生成 32 位随机密钥
openssl rand -base64 32
# 或在线生成：https://generate-secret.vercel.app/32
```

### DATABASE_URL
```bash
# 格式
postgresql://用户名:密码@主机:端口/数据库名?schema=public

# 示例
postgresql://social_user:your_password@localhost:5432/social_prod?schema=public
```

### UploadThing 配置
1. 访问 https://uploadthing.com/dashboard
2. 创建应用获取 Secret 和 App ID
3. 复制到环境变量中

## 📝 .gitignore 配置

确保您的 `.gitignore` 包含：

```gitignore
# 环境变量文件
.env
.env.local
.env.development
.env.production
.env.test

# 但允许模板文件
!.env.example
!.env.template

# 其他敏感文件
*.log
.DS_Store
node_modules/
.next/
dist/
```

## 🚨 安全最佳实践

### ✅ 应该做的
- 使用强密码和随机密钥
- 定期轮换敏感凭证
- 使用环境变量而非硬编码
- 限制数据库用户权限
- 启用防火墙和 SSL

### ❌ 不应该做的
- 将 .env 文件上传到版本控制
- 在代码中硬编码密钥
- 使用弱密码
- 共享生产环境凭证
- 在日志中打印敏感信息

## 🛡️ 泄露后的应对措施

如果不小心上传了 .env 文件：

1. **立即撤销凭证**：
   - 重置数据库密码
   - 重新生成 API 密钥
   - 更换 JWT 密钥

2. **清理 Git 历史**：
   ```bash
   # 从历史记录中完全删除
   git filter-branch --force --index-filter \
   'git rm --cached --ignore-unmatch .env' \
   --prune-empty --tag-name-filter cat -- --all

   # 强制推送
   git push origin --force --all
   ```

3. **更新部署**：
   - 使用新的环境变量重新部署
   - 通知相关人员安全事件
