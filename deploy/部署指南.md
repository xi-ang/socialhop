# 🚀 阿里云部署完整步骤（零基础）

按照以下步骤，您可以将项目成功部署到阿里云服务器。

## 📋 部署清单

### ✅ 准备工作
- [ ] 购买阿里云 ECS 服务器
- [ ] 配置安全组（开放22、80、443、3000端口）
- [ ] 获取 UploadThing 密钥
- [ ] （可选）购买域名

### ✅ 服务器配置
- [ ] 连接到服务器
- [ ] 运行环境安装脚本
- [ ] 验证环境安装

### ✅ 代码部署
- [ ] 上传代码到服务器
- [ ] 配置环境变量
- [ ] 运行部署脚本

### ✅ 域名和SSL（可选）
- [ ] 配置域名解析
- [ ] 安装SSL证书
- [ ] 配置Nginx反向代理

## 🚀 详细执行步骤

### 步骤1：购买和配置服务器（10分钟）

1. **登录阿里云控制台**
   - 访问：https://ecs.console.aliyun.com
   - 点击"创建实例"

2. **选择配置**
   ```
   地域：选择离您最近的
   实例：ecs.t5-lc1m2.small (1核2G) 或更高
   镜像：Ubuntu 20.04 64位
   存储：系统盘 SSD 40GB
   网络：分配公网IP
   安全组：允许22、80、443、3000端口
   ```

3. **设置密码**
   - 记住您设置的root密码

### 步骤2：连接服务器（5分钟）

```bash
# Windows PowerShell 或 CMD
ssh root@你的服务器IP

# 首次连接选择 yes
# 输入密码登录
```

### 步骤3：一键安装环境（15分钟）

```bash
# 在服务器执行
wget https://raw.githubusercontent.com/xi-ang/socialhop/master/deploy/setup.sh
chmod +x setup.sh
./setup.sh

# 脚本会自动安装：
# - Node.js 18
# - pnpm
# - PM2  
# - PostgreSQL
# - Nginx
```

### 步骤4：上传代码（5分钟）

**方法A：Git克隆（推荐）**
```bash
cd /var/www/social
git clone https://github.com/xi-ang/socialhop.git .
```

**方法B：本地上传**
```bash
# 在本地电脑执行
scp -r "E:\myy_work\social" root@你的服务器IP:/var/www/
```

### 步骤5：配置环境变量（5分钟）

```bash
# 在服务器执行
cd /var/www/social
cp deploy/.env.production.template .env.production
vim .env.production

# 修改以下配置：
# - 域名地址（如果有）
# - UploadThing 密钥
# - 生成 NEXTAUTH_SECRET
```

### 步骤6：部署应用（10分钟）

```bash
# 在服务器的 /var/www/social 目录执行
chmod +x deploy/deploy.sh
./deploy/deploy.sh

# 脚本会自动：
# - 安装依赖
# - 数据库迁移
# - 构建项目
# - 启动服务
```

### 步骤7：验证部署（2分钟）

```bash
# 检查应用状态
pm2 status

# 查看日志
pm2 logs social-app

# 测试访问
curl http://localhost:3000
```

浏览器访问：`http://你的服务器IP:3000`

### 步骤8：配置域名和SSL（可选，20分钟）

如果您有域名：

1. **配置域名解析**
   - A记录：@ → 服务器IP
   - A记录：www → 服务器IP

2. **安装SSL证书**
   ```bash
   sudo apt install certbot python3-certbot-nginx
   sudo systemctl stop nginx
   sudo certbot certonly --standalone -d 你的域名.com -d www.你的域名.com
   ```

3. **配置Nginx**
   ```bash
   sudo cp deploy/nginx-config /etc/nginx/sites-available/social-app
   # 编辑配置文件，替换域名
   sudo vim /etc/nginx/sites-available/social-app
   sudo ln -s /etc/nginx/sites-available/social-app /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl start nginx
   ```

## 🎉 部署完成！

### 访问地址
- **IP访问**：http://你的服务器IP:3000
- **域名访问**：https://你的域名.com

### 常用管理命令

```bash
# 查看应用状态
pm2 status

# 重启应用
pm2 restart social-app

# 查看日志
pm2 logs social-app

# 更新代码
cd /var/www/social
git pull
pnpm build
pm2 restart social-app

# 查看系统状态
./deploy/monitor.sh
```

## 🚨 如果遇到问题

### 1. 应用无法启动
```bash
# 查看详细错误
pm2 logs social-app --lines 50

# 检查环境变量
cat .env.production
```

### 2. 无法访问应用
```bash
# 检查防火墙
sudo ufw status

# 检查端口占用
netstat -tulpn | grep :3000

# 检查进程状态
pm2 status
```

### 3. 数据库连接失败
```bash
# 检查数据库状态
sudo systemctl status postgresql

# 测试数据库连接
psql -U social_user -h localhost -d social_prod
```

## 📞 获取帮助

如果在部署过程中遇到任何问题：

1. 查看错误日志：`pm2 logs social-app`
2. 检查系统状态：`./deploy/monitor.sh`
3. 参考文档目录下的详细指南
4. 联系技术支持或查看项目 Issues

**🎊 恭喜！您已成功将应用部署到阿里云！**
