# ğŸš€ Social Media Platform - æŠ€æœ¯å®ç°ä¸æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [å…³é”®åŠŸèƒ½å®ç°](#å…³é”®åŠŸèƒ½å®ç°)
4. [æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ](#æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ)
5. [å®‰å…¨æ€§å®ç°](#å®‰å…¨æ€§å®ç°)
6. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
7. [çŠ¶æ€ç®¡ç†æ¶æ„](#çŠ¶æ€ç®¡ç†æ¶æ„)
8. [æ–‡ä»¶ç»„ç»‡ç»“æ„](#æ–‡ä»¶ç»„ç»‡ç»“æ„)
9. [APIè®¾è®¡è§„èŒƒ](#apiè®¾è®¡è§„èŒƒ)
10. [éƒ¨ç½²ä¸è¿ç»´](#éƒ¨ç½²ä¸è¿ç»´)

---

### é¡¹ç›®ä¸­çš„é¡µé¢æ¸²æŸ“æ–¹å¼å¦‚ä¸‹ï¼š

ğŸ” SSRé¡µé¢ (æœåŠ¡ç«¯æ¸²æŸ“):

âœ… ä¸»é¡µ (page.tsx) - ä½¿ç”¨ async function è·å–åˆå§‹æ•°æ®
âœ… ç”¨æˆ·èµ„æ–™é¡µ (page.tsx) - è®¾ç½®äº† export const dynamic = 'force-dynamic'
âœ… å¸–å­è¯¦æƒ…é¡µ (page.tsx) - å¼‚æ­¥è·å–å¸–å­æ•°æ®
âœ… ç”¨æˆ·é¡µé¢ (page.tsx) - æœåŠ¡ç«¯æ•°æ®è·å–
ğŸ”„ CSRé¡µé¢ (å®¢æˆ·ç«¯æ¸²æŸ“):

âœ… ç™»å½•é¡µé¢ (page.tsx) - ä½¿ç”¨ 'use client'
âœ… æ³¨å†Œé¡µé¢ (page.tsx) - ä½¿ç”¨ 'use client'
âœ… è®¾ç½®é¡µé¢ (page.tsx) - ä½¿ç”¨ 'use client'
âœ… é€šçŸ¥è®¾ç½® (page.tsx) - ä½¿ç”¨ 'use client'
ğŸ“Š æ€»ç»“:

ä¸æ˜¯æ‰€æœ‰é¡µé¢éƒ½æ˜¯SSR - é¡¹ç›®é‡‡ç”¨äº†æ··åˆæ¸²æŸ“ç­–ç•¥
æ ¸å¿ƒå†…å®¹é¡µé¢ä½¿ç”¨SSR - æœ‰åˆ©äºSEOå’Œé¦–å±åŠ è½½
äº¤äº’å¯†é›†é¡µé¢ä½¿ç”¨CSR - å¦‚ç™»å½•ã€è®¾ç½®ç­‰åŠŸèƒ½é¡µé¢

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Next.js 14 æ„å»ºçš„ç°ä»£åŒ–ç¤¾äº¤åª’ä½“å¹³å°ï¼Œå…·å¤‡å®Œæ•´çš„ç”¨æˆ·äº¤äº’åŠŸèƒ½ï¼ŒåŒ…æ‹¬å‘å¸–ã€è¯„è®ºã€ç‚¹èµã€å…³æ³¨ã€@æåŠã€é€šçŸ¥ç³»ç»Ÿç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… ç”¨æˆ·è®¤è¯ä¸æˆæƒç³»ç»Ÿ
- âœ… å¸–å­å‘å¸ƒä¸å¤šåª’ä½“æ”¯æŒ
- âœ… å®æ—¶äº¤äº’ï¼ˆç‚¹èµã€è¯„è®ºã€å…³æ³¨ï¼‰
- âœ… @æåŠåŠŸèƒ½ä¸é€šçŸ¥ç³»ç»Ÿ
- âœ… ä¸ªäººèµ„æ–™ç®¡ç†
- âœ… å¤´åƒä¸Šä¼ ä¸å›¾ç‰‡å¤„ç†
- âœ… XSSé˜²æŠ¤ä¸å†…å®¹å®‰å…¨
- âœ… å“åº”å¼è®¾è®¡
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆISRã€ç¼“å­˜ï¼‰

---

## ğŸ›  æŠ€æœ¯æ ˆ

### å‰ç«¯æŠ€æœ¯
- **æ¡†æ¶**: Next.js 14 (App Router)
- **è¯­è¨€**: TypeScript
- **æ ·å¼**: Tailwind CSS + Shadcn/ui
- **çŠ¶æ€ç®¡ç†**: React Context API + useState/useReducer
- **è¡¨å•å¤„ç†**: React Hook Form + ZodéªŒè¯
- **å›¾æ ‡**: Lucide React
- **é€šçŸ¥**: React Hot Toast

### åç«¯æŠ€æœ¯
- **è¿è¡Œæ—¶**: Node.js (Next.js API Routes)
- **æ•°æ®åº“**: PostgreSQL (Neon)
- **ORM**: Prisma
- **è®¤è¯**: è‡ªå®šä¹‰JWT + bcryptjs
- **æ–‡ä»¶ä¸Šä¼ **: UploadThing
- **æœåŠ¡å™¨æ“ä½œ**: Next.js Server Actions

### å¼€å‘å·¥å…·
- **åŒ…ç®¡ç†**: npm
- **ä»£ç æ ¼å¼åŒ–**: Prettier + ESLint
- **ç±»å‹æ£€æŸ¥**: TypeScript
- **ç‰ˆæœ¬æ§åˆ¶**: Git

---

## ğŸ”§ å…³é”®åŠŸèƒ½å®ç°

### 1. è®¤è¯ç³»ç»Ÿ

#### JWT Tokenå®ç°
```typescript
// lib/auth.ts
export function generateToken(userId: string): string {
  return jwt.sign({ userId }, JWT_SECRET, { expiresIn: '7d' });
}

export function verifyToken(token: string): { userId: string } | null {
  try {
    return jwt.verify(token, JWT_SECRET) as { userId: string };
  } catch {
    return null;
  }
}
```

#### å¯†ç å®‰å…¨
- ä½¿ç”¨ bcryptjs è¿›è¡Œå¯†ç å“ˆå¸Œ
- ç›å€¼è½®æ•°è®¾ç½®ä¸º 12
- æ”¯æŒå¯†ç å¼ºåº¦éªŒè¯

### 2. @æåŠåŠŸèƒ½

#### å®æ—¶ç”¨æˆ·æœç´¢
```typescript
// components/posts/MentionInput.tsx
const handleInputChange = useCallback(
  debounce(async (query: string) => {
    if (query.length >= 1) {
      const response = await fetch(`/api/users/search?q=${query}&limit=5`);
      const data = await response.json();
      if (data.success) {
        setFilteredUsers(data.users);
        setShowDropdown(true);
      }
    }
  }, 300),
  []
);
```

#### æåŠé€šçŸ¥ç³»ç»Ÿ
- è§£æå¸–å­å†…å®¹ä¸­çš„@ç”¨æˆ·å
- æ£€æŸ¥ç”¨æˆ·é€šçŸ¥è®¾ç½®
- å¼‚æ­¥åˆ›å»ºé€šçŸ¥è®°å½•
- æ”¯æŒæ‰¹é‡é€šçŸ¥å¤„ç†

### 3. æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ

#### å¤šå›¾ç‰‡ä¸Šä¼ 
```typescript
// components/posts/MultiImageUpload.tsx
const uploadFiles = async (files: File[]) => {
  const uploadPromises = files.map(file => 
    startUpload([file]).then(res => res?.[0]?.url)
  );
  
  const urls = await Promise.all(uploadPromises);
  return urls.filter(Boolean);
};
```

#### å›¾ç‰‡é¢„è§ˆä¸ç®¡ç†
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
- å®æ—¶é¢„è§ˆåŠŸèƒ½
- å›¾ç‰‡åˆ é™¤ä¸é‡æ–°æ’åº
- æœ€å¤§9å¼ å›¾ç‰‡é™åˆ¶

### 4. å®æ—¶äº¤äº’åŠŸèƒ½

#### ä¹è§‚æ›´æ–°
```typescript
// ç‚¹èµåŠŸèƒ½çš„ä¹è§‚æ›´æ–°
const handleLike = async () => {
  // ç«‹å³æ›´æ–°UI
  setHasLiked(prev => !prev);
  setOptimisticLikes(prev => prev + (hasLiked ? -1 : 1));
  
  try {
    // å‘é€APIè¯·æ±‚
    await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
  } catch (error) {
    // å¤±è´¥æ—¶å›æ»š
    setHasLiked(prev => !prev);
    setOptimisticLikes(originalCount);
  }
};
```

#### è¯„è®ºç³»ç»Ÿ
- åµŒå¥—è¯„è®ºæ˜¾ç¤º
- å®æ—¶è¯„è®ºè®¡æ•°
- è¯„è®ºå†…å®¹@æåŠæ”¯æŒ

---

## ğŸš¨ æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### 1. Next.jsè·¯ç”±å†²çªé—®é¢˜

**é—®é¢˜**: `/profile/[id]` å’Œ `/users/[username]` è·¯ç”±å†²çª

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// app/users/[username]/page.tsx -> app/api/users/by-username/[username]/route.ts
export async function GET(request: NextRequest, { params }: { params: { username: string } }) {
  const user = await prisma.user.findUnique({
    where: { username },
    select: { id: true }
  });
  
  if (user) {
    return NextResponse.json({ success: true, userId: user.id });
  }
}
```

### 2. ç±»å‹å®‰å…¨ä¸Prismaé›†æˆ

**æŒ‘æˆ˜**: Prismaç”Ÿæˆçš„ç±»å‹ä¸ç»„ä»¶propsçš„åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ç»Ÿä¸€ç±»å‹å®šä¹‰
type Posts = Awaited<ReturnType<typeof getPosts>>;
type Post = Posts[number];

// ç±»å‹å®‰å…¨çš„APIè°ƒç”¨
export async function getPosts(): Promise<PostWithAuthorAndCounts[]> {
  return await prisma.post.findMany({
    include: {
      author: { select: { id: true, username: true, name: true, image: true } },
      _count: { select: { likes: true, comments: true } }
    }
  });
}
```

### 3. XSSé˜²æŠ¤å®ç°

**æŒ‘æˆ˜**: ç”¨æˆ·ç”Ÿæˆå†…å®¹çš„å®‰å…¨å¤„ç†

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// lib/security.ts
export function detectXSS(input: string): boolean {
  const xssPatterns = [
    /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
    /javascript:/gi,
    /on\w+\s*=/gi,
    /<iframe/gi,
    /<object/gi,
    /<embed/gi
  ];
  
  return xssPatterns.some(pattern => pattern.test(input));
}

export function sanitizeContent(content: string): string {
  return content
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}
```

### 4. å®æ—¶æœç´¢æ€§èƒ½ä¼˜åŒ–

**æŒ‘æˆ˜**: ç”¨æˆ·æœç´¢çš„æ€§èƒ½ä¸ç”¨æˆ·ä½“éªŒ

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// é˜²æŠ– + ç¼“å­˜ + å–æ¶ˆè¯·æ±‚
const searchCache = new Map();
const abortController = useRef<AbortController | null>(null);

const debouncedSearch = useCallback(
  debounce(async (query: string) => {
    // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
    if (abortController.current) {
      abortController.current.abort();
    }
    
    abortController.current = new AbortController();
    
    // æ£€æŸ¥ç¼“å­˜
    if (searchCache.has(query)) {
      setResults(searchCache.get(query));
      return;
    }
    
    try {
      const response = await fetch(`/api/search?q=${query}`, {
        signal: abortController.current.signal
      });
      const data = await response.json();
      
      // ç¼“å­˜ç»“æœ
      searchCache.set(query, data.results);
      setResults(data.results);
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('Search error:', error);
      }
    }
  }, 300),
  []
);
```

---

## ğŸ”’ å®‰å…¨æ€§å®ç°

### 1. è¾“å…¥éªŒè¯ä¸æ¸…ç†
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯å’Œæ¸…ç†
- ä½¿ç”¨Zodè¿›è¡Œè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
- å®æ–½å†…å®¹é•¿åº¦é™åˆ¶

### 2. è®¤è¯ä¸æˆæƒ
- JWT tokençš„å®‰å…¨å­˜å‚¨ï¼ˆhttpOnly cookiesï¼‰
- è·¯ç”±çº§åˆ«çš„æƒé™æ§åˆ¶
- APIç«¯ç‚¹çš„èº«ä»½éªŒè¯

### 3. XSSé˜²æŠ¤
- å†…å®¹æ¸²æŸ“å‰çš„å®‰å…¨æ£€æŸ¥
- HTMLæ ‡ç­¾çš„è½¬ä¹‰å¤„ç†
- CSPå¤´çš„å®æ–½

### 4. æ•°æ®åº“å®‰å…¨
- Prisma ORMé˜²æ­¢SQLæ³¨å…¥
- æ•æ„Ÿæ•°æ®çš„é€‰æ‹©æ€§æŸ¥è¯¢
- ç”¨æˆ·æƒé™çš„æ•°æ®åº“çº§åˆ«æ§åˆ¶

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. Next.jsä¼˜åŒ–
```typescript
// é™æ€ç”Ÿæˆ + ISR
export const revalidate = 60; // 60ç§’é‡æ–°éªŒè¯

// åŠ¨æ€å¯¼å…¥
const PostCard = dynamic(() => import('./PostCard'), {
  loading: () => <PostCardSkeleton />,
  ssr: false
});

// å›¾ç‰‡ä¼˜åŒ–
import Image from 'next/image';
<Image
  src={post.image}
  alt="Post image"
  width={500}
  height={300}
  priority={index < 2}
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,..."
/>
```

### 2. æ•°æ®åº“ä¼˜åŒ–
```typescript
// ç´¢å¼•ä¼˜åŒ–
model Post {
  // ...
  @@index([authorId, createdAt])
  @@index([createdAt])
}

// é€‰æ‹©æ€§æŸ¥è¯¢
const posts = await prisma.post.findMany({
  select: {
    id: true,
    content: true,
    createdAt: true,
    author: {
      select: { id: true, username: true, name: true, image: true }
    },
    _count: {
      select: { likes: true, comments: true }
    }
  }
});
```

### 3. å®¢æˆ·ç«¯ä¼˜åŒ–
- è™šæ‹Ÿæ»šåŠ¨ï¼ˆé•¿åˆ—è¡¨ï¼‰
- å›¾ç‰‡æ‡’åŠ è½½
- ç»„ä»¶çº§åˆ«çš„memoä¼˜åŒ–
- é˜²æŠ–å’ŒèŠ‚æµ

---

## ğŸ“± çŠ¶æ€ç®¡ç†æ¶æ„

### ğŸ¯ å·²å®Œæˆçš„Redux Toolkitè¿ç§»

#### è¿ç§»çŠ¶æ€: âœ… **å®Œæˆ**
é¡¹ç›®å·²æˆåŠŸä»React Contextè¿ç§»åˆ°Redux Toolkitï¼Œæä¾›äº†æ›´å¼ºå¤§çš„çŠ¶æ€ç®¡ç†èƒ½åŠ›ã€‚

#### å½“å‰å®ç°ï¼šRedux Toolkit + Redux Persist

#### æ¶æ„ä¼˜åŠ¿
1. **æŒä¹…åŒ–å­˜å‚¨**: ç”¨æˆ·è®¤è¯çŠ¶æ€è‡ªåŠ¨ä¿å­˜åˆ°localStorage
2. **å¼€å‘è€…å·¥å…·**: Redux DevToolsæ”¯æŒï¼Œæä¾›æ—¶é—´æ—…è¡Œè°ƒè¯•
3. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹æ¨å¯¼
4. **æ€§èƒ½ä¼˜åŒ–**: ç²¾ç¡®çš„çŠ¶æ€è®¢é˜…ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
5. **æ ‡å‡†åŒ–**: é‡‡ç”¨Reduxç”Ÿæ€ç³»ç»Ÿçš„æœ€ä½³å®è·µ

#### Storeæ¶æ„è®¾è®¡
```typescript
// store/index.ts
const store = configureStore({
  reducer: {
    auth: authSlice,           // ç”¨æˆ·è®¤è¯çŠ¶æ€
    posts: postsSlice,         // å¸–å­æ•°æ®çŠ¶æ€  
    notifications: notificationsSlice  // é€šçŸ¥çŠ¶æ€
  },
  middleware: [...],
  devTools: process.env.NODE_ENV !== 'production',
});
```

#### State Slices è¯¦è§£

##### 1. AuthSlice - è®¤è¯çŠ¶æ€ç®¡ç†
```typescript
interface AuthState {
  user: User | null;
  loading: boolean;
  error: string | null;
  isAuthenticated: boolean;
}

// å¼‚æ­¥Actions
- loginUser: ç”¨æˆ·ç™»å½•
- registerUser: ç”¨æˆ·æ³¨å†Œ  
- checkAuth: æ£€æŸ¥è®¤è¯çŠ¶æ€
- logoutUser: ç”¨æˆ·ç™»å‡º

// åŒæ­¥Actions
- updateUser: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- clearError: æ¸…é™¤é”™è¯¯çŠ¶æ€
- resetAuth: é‡ç½®è®¤è¯çŠ¶æ€
```

##### 2. PostsSlice - å¸–å­çŠ¶æ€ç®¡ç†
```typescript
interface PostsState {
  posts: Post[];
  loading: boolean;
  error: string | null;
  pagination: Pagination;
  refreshCounter: number;
}

// å¼‚æ­¥Actions
- fetchPosts: è·å–å¸–å­åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
- toggleLike: ç‚¹èµ/å–æ¶ˆç‚¹èµ

// åŒæ­¥Actions  
- addPost: æ·»åŠ æ–°å¸–å­
- removePost: åˆ é™¤å¸–å­
- updatePost: æ›´æ–°å¸–å­
- refreshPosts: è§¦å‘åˆ·æ–°
- optimisticToggleLike: ä¹è§‚æ›´æ–°ç‚¹èµçŠ¶æ€
```

##### 3. NotificationsSlice - é€šçŸ¥çŠ¶æ€ç®¡ç†
```typescript
interface NotificationsState {
  notifications: Notification[];
  unreadCount: number;
  settings: NotificationSettings;
  loading: boolean;
  error: string | null;
}

// Actions
- setNotifications: è®¾ç½®é€šçŸ¥åˆ—è¡¨
- addNotification: æ·»åŠ æ–°é€šçŸ¥
- markAsRead: æ ‡è®°ä¸ºå·²è¯»
- markAllAsRead: å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»
- removeNotification: åˆ é™¤é€šçŸ¥
- updateSettings: æ›´æ–°é€šçŸ¥è®¾ç½®
```

#### è‡ªå®šä¹‰Hookså®ç°
```typescript
// hooks/useAuth.ts - è®¤è¯ç›¸å…³æ“ä½œ
export const useAuth = () => {
  const dispatch = useAppDispatch();
  const { user, loading, error, isAuthenticated } = useAppSelector(state => state.auth);
  
  return {
    user, loading, error, isAuthenticated,
    login: (email, password) => dispatch(loginUser({ email, password })),
    logout: () => dispatch(logoutUser()),
    updateUser: (data) => dispatch(updateUser(data)),
  };
};

// hooks/usePosts.ts - å¸–å­ç›¸å…³æ“ä½œ
export const usePosts = () => {
  const dispatch = useAppDispatch();
  const { posts, loading, pagination } = useAppSelector(state => state.posts);
  
  return {
    posts, loading, pagination,
    loadPosts: (page) => dispatch(fetchPosts({ page })),
    toggleLike: (postId, currentStatus) => {
      // ä¹è§‚æ›´æ–°
      dispatch(optimisticToggleLike({ postId, hasLiked: !currentStatus }));
      // å®é™…APIè°ƒç”¨
      dispatch(toggleLike({ postId }));
    },
  };
};
```

#### æŒä¹…åŒ–é…ç½®
```typescript
const persistConfig = {
  key: 'root',
  storage,
  whitelist: ['auth'], // åªæŒä¹…åŒ–è®¤è¯çŠ¶æ€
};
```

#### æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§
1. **é€‰æ‹©å™¨ä¼˜åŒ–**: ä½¿ç”¨useAppSelectorç²¾ç¡®è®¢é˜…çŠ¶æ€ç‰‡æ®µ
2. **ä¹è§‚æ›´æ–°**: ç‚¹èµç­‰æ“ä½œç«‹å³æ›´æ–°UIï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
3. **è¯·æ±‚ç¼“å­˜**: Redux Toolkit Queryæ½œåœ¨é›†æˆèƒ½åŠ›
4. **å†…å­˜ç®¡ç†**: ç²¾ç¡®çš„çŠ¶æ€è®¢é˜…é¿å…å†…å­˜æ³„æ¼

#### å¼€å‘ä½“éªŒæå‡
1. **Redux DevTools**: 
   - æ—¶é—´æ—…è¡Œè°ƒè¯•
   - Actionå†å²è®°å½•
   - çŠ¶æ€å˜åŒ–å¯è§†åŒ–
2. **ç±»å‹å®‰å…¨**: 
   - å®Œæ•´çš„TypeScriptæ”¯æŒ
   - ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
   - æ™ºèƒ½ä»£ç æç¤º
3. **æ ‡å‡†åŒ–**: 
   - Reduxæœ€ä½³å®è·µ
   - å¯é¢„æµ‹çš„çŠ¶æ€æ›´æ–°
   - æ›´å¥½çš„å›¢é˜Ÿåä½œ

### ğŸ”„ ä»Contextåˆ°Reduxçš„è¿ç§»æ”¶ç›Š

#### æŠ€æœ¯æ”¶ç›Š
- âœ… **æ›´å¥½çš„è°ƒè¯•**: Redux DevToolså¼ºå¤§çš„è°ƒè¯•èƒ½åŠ›
- âœ… **æ€§èƒ½æå‡**: ç²¾ç¡®çš„çŠ¶æ€è®¢é˜…ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“  
- âœ… **å¯æ‰©å±•æ€§**: æ›´é€‚åˆå¤æ‚çŠ¶æ€ç®¡ç†éœ€æ±‚
- âœ… **æ ‡å‡†åŒ–**: é‡‡ç”¨è¡Œä¸šæ ‡å‡†çš„çŠ¶æ€ç®¡ç†æ¨¡å¼

#### ç”¨æˆ·ä½“éªŒæ”¶ç›Š
- âœ… **çŠ¶æ€æŒä¹…åŒ–**: ç”¨æˆ·ç™»å½•çŠ¶æ€è·¨sessionä¿æŒ
- âœ… **å“åº”æ€§èƒ½**: ä¹è§‚æ›´æ–°æä¾›å³æ—¶åé¦ˆ
- âœ… **ç¨³å®šæ€§**: æ›´å¯é¢„æµ‹çš„çŠ¶æ€å˜æ›´æµç¨‹

#### å¼€å‘æ•ˆç‡æ”¶ç›Š
- âœ… **è°ƒè¯•æ•ˆç‡**: å¼ºå¤§çš„è°ƒè¯•å·¥å…·
- âœ… **å›¢é˜Ÿåä½œ**: æ ‡å‡†åŒ–çš„çŠ¶æ€ç®¡ç†æ¨¡å¼
- âœ… **ä»£ç è´¨é‡**: æ›´å¥½çš„ç±»å‹å®‰å…¨å’Œé”™è¯¯å¤„ç†

### ğŸ¯ APIå…¼å®¹æ€§ä¿è¯

è¿ç§»è¿‡ç¨‹ä¸­ä¿æŒäº†å®Œå…¨çš„APIå…¼å®¹æ€§ï¼š

```typescript
// è¿ç§»å‰åçš„ä½¿ç”¨æ–¹å¼å®Œå…¨ä¸€è‡´
const { user, login, logout } = useAuth();
const { posts, loading, toggleLike } = usePosts();
```

è¿™ç¡®ä¿äº†:
- âœ… é›¶ç ´åæ€§å˜æ›´
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½ä¿ç•™
- âœ… å¹³æ»‘çš„è¿ç§»ä½“éªŒ
- âœ… å‘åå…¼å®¹æ€§

---

## ğŸ”„ è¿ç§»åˆ°Redux Toolkitæ–¹æ¡ˆ

### ä¸ºä»€ä¹ˆè€ƒè™‘Redux Toolkit

1. **çŠ¶æ€å¤æ‚åº¦å¢é•¿**: éšç€åŠŸèƒ½å¢åŠ ï¼ŒçŠ¶æ€ç®¡ç†å˜å¾—å¤æ‚
2. **æ€§èƒ½ä¼˜åŒ–**: æ›´ç»†ç²’åº¦çš„çŠ¶æ€æ›´æ–°æ§åˆ¶
3. **å¼€å‘è€…å·¥å…·**: å¼ºå¤§çš„è°ƒè¯•å·¥å…·
4. **ä¸­é—´ä»¶ç”Ÿæ€**: ä¸°å¯Œçš„ä¸­é—´ä»¶æ”¯æŒ
5. **å›¢é˜Ÿåä½œ**: æ›´æ ‡å‡†åŒ–çš„çŠ¶æ€ç®¡ç†

### è¿ç§»å®æ–½æ–¹æ¡ˆ

#### 1. å®‰è£…ä¾èµ–
```bash
npm install @reduxjs/toolkit react-redux redux-persist
npm install -D @types/react-redux
```

#### 2. Storeé…ç½®
```typescript
// store/index.ts
import { configureStore } from '@reduxjs/toolkit';
import { persistStore, persistReducer } from 'redux-persist';
import storage from 'redux-persist/lib/storage';
import { combineReducers } from '@reduxjs/toolkit';

import authSlice from './slices/authSlice';
import postsSlice from './slices/postsSlice';
import notificationsSlice from './slices/notificationsSlice';

const persistConfig = {
  key: 'root',
  storage,
  whitelist: ['auth'], // åªæŒä¹…åŒ–authçŠ¶æ€
};

const rootReducer = combineReducers({
  auth: authSlice,
  posts: postsSlice,
  notifications: notificationsSlice,
});

const persistedReducer = persistReducer(persistConfig, rootReducer);

export const store = configureStore({
  reducer: persistedReducer,
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: ['persist/PERSIST', 'persist/REHYDRATE'],
      },
    }),
  devTools: process.env.NODE_ENV !== 'production',
});

export const persistor = persistStore(store);
export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

#### 3. Auth Sliceå®ç°
```typescript
// store/slices/authSlice.ts
import { createSlice, createAsyncThunk, PayloadAction } from '@reduxjs/toolkit';

interface User {
  id: string;
  email: string;
  username: string;
  name: string;
  image?: string;
}

interface AuthState {
  user: User | null;
  isLoading: boolean;
  error: string | null;
  isAuthenticated: boolean;
}

const initialState: AuthState = {
  user: null,
  isLoading: false,
  error: null,
  isAuthenticated: false,
};

// å¼‚æ­¥actions
export const loginUser = createAsyncThunk(
  'auth/login',
  async ({ email, password }: { email: string; password: string }, { rejectWithValue }) => {
    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });
      
      const data = await response.json();
      
      if (!data.success) {
        return rejectWithValue(data.error);
      }
      
      return data.user;
    } catch (error) {
      return rejectWithValue('ç™»å½•å¤±è´¥');
    }
  }
);

export const logoutUser = createAsyncThunk(
  'auth/logout',
  async (_, { rejectWithValue }) => {
    try {
      await fetch('/api/auth/logout', { method: 'POST' });
      return null;
    } catch (error) {
      return rejectWithValue('ç™»å‡ºå¤±è´¥');
    }
  }
);

export const updateUserProfile = createAsyncThunk(
  'auth/updateProfile',
  async (userData: Partial<User>, { rejectWithValue }) => {
    try {
      const response = await fetch('/api/user/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData),
      });
      
      const data = await response.json();
      
      if (!data.success) {
        return rejectWithValue(data.error);
      }
      
      return data.user;
    } catch (error) {
      return rejectWithValue('æ›´æ–°å¤±è´¥');
    }
  }
);

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    setUser: (state, action: PayloadAction<User>) => {
      state.user = action.payload;
      state.isAuthenticated = true;
    },
  },
  extraReducers: (builder) => {
    builder
      // Login
      .addCase(loginUser.pending, (state) => {
        state.isLoading = true;
        state.error = null;
      })
      .addCase(loginUser.fulfilled, (state, action) => {
        state.isLoading = false;
        state.user = action.payload;
        state.isAuthenticated = true;
        state.error = null;
      })
      .addCase(loginUser.rejected, (state, action) => {
        state.isLoading = false;
        state.error = action.payload as string;
        state.isAuthenticated = false;
      })
      // Logout
      .addCase(logoutUser.fulfilled, (state) => {
        state.user = null;
        state.isAuthenticated = false;
        state.error = null;
      })
      // Update Profile
      .addCase(updateUserProfile.fulfilled, (state, action) => {
        state.user = { ...state.user, ...action.payload };
      });
  },
});

export const { clearError, setUser } = authSlice.actions;
export default authSlice.reducer;
```

#### 4. Posts Sliceå®ç°
```typescript
// store/slices/postsSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';

interface Post {
  id: string;
  content: string;
  images: string[];
  createdAt: string;
  author: {
    id: string;
    username: string;
    name: string;
    image?: string;
  };
  _count: {
    likes: number;
    comments: number;
  };
  isLiked: boolean;
}

interface PostsState {
  posts: Post[];
  isLoading: boolean;
  error: string | null;
  page: number;
  hasMore: boolean;
}

const initialState: PostsState = {
  posts: [],
  isLoading: false,
  error: null,
  page: 1,
  hasMore: true,
};

export const fetchPosts = createAsyncThunk(
  'posts/fetchPosts',
  async ({ page = 1, limit = 10 }: { page?: number; limit?: number }) => {
    const response = await fetch(`/api/posts?page=${page}&limit=${limit}`);
    const data = await response.json();
    return { posts: data.data.posts, pagination: data.data.pagination };
  }
);

export const createPost = createAsyncThunk(
  'posts/createPost',
  async ({ content, images, mentions }: { content: string; images: string[]; mentions: any[] }) => {
    const response = await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, images, mentions }),
    });
    const data = await response.json();
    return data.post;
  }
);

export const togglePostLike = createAsyncThunk(
  'posts/toggleLike',
  async (postId: string, { getState }) => {
    const response = await fetch(`/api/posts/${postId}/like`, {
      method: 'POST',
    });
    const data = await response.json();
    return { postId, isLiked: data.isLiked, likesCount: data.likesCount };
  }
);

const postsSlice = createSlice({
  name: 'posts',
  initialState,
  reducers: {
    resetPosts: (state) => {
      state.posts = [];
      state.page = 1;
      state.hasMore = true;
    },
    // ä¹è§‚æ›´æ–°
    optimisticLike: (state, action) => {
      const { postId } = action.payload;
      const post = state.posts.find(p => p.id === postId);
      if (post) {
        post.isLiked = !post.isLiked;
        post._count.likes += post.isLiked ? 1 : -1;
      }
    },
  },
  extraReducers: (builder) => {
    builder
      .addCase(fetchPosts.pending, (state) => {
        state.isLoading = true;
      })
      .addCase(fetchPosts.fulfilled, (state, action) => {
        state.isLoading = false;
        const { posts, pagination } = action.payload;
        
        if (pagination.page === 1) {
          state.posts = posts;
        } else {
          state.posts.push(...posts);
        }
        
        state.page = pagination.page;
        state.hasMore = pagination.hasMore;
      })
      .addCase(createPost.fulfilled, (state, action) => {
        state.posts.unshift(action.payload);
      })
      .addCase(togglePostLike.fulfilled, (state, action) => {
        const { postId, isLiked, likesCount } = action.payload;
        const post = state.posts.find(p => p.id === postId);
        if (post) {
          post.isLiked = isLiked;
          post._count.likes = likesCount;
        }
      });
  },
});

export const { resetPosts, optimisticLike } = postsSlice.actions;
export default postsSlice.reducer;
```

#### 5. Provideré…ç½®
```typescript
// app/providers.tsx
'use client';

import React from 'react';
import { Provider } from 'react-redux';
import { PersistGate } from 'redux-persist/integration/react';
import { store, persistor } from '@/store';

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <Provider store={store}>
      <PersistGate loading={<div>Loading...</div>} persistor={persistor}>
        {children}
      </PersistGate>
    </Provider>
  );
}
```

#### 6. è‡ªå®šä¹‰Hooks
```typescript
// hooks/redux.ts
import { useDispatch, useSelector, TypedUseSelectorHook } from 'react-redux';
import type { RootState, AppDispatch } from '@/store';

export const useAppDispatch = () => useDispatch<AppDispatch>();
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;

// ä¾¿æ·çš„è®¤è¯hooks
export const useAuth = () => {
  const dispatch = useAppDispatch();
  const { user, isLoading, error, isAuthenticated } = useAppSelector(state => state.auth);
  
  return {
    user,
    isLoading,
    error,
    isAuthenticated,
    login: (email: string, password: string) => dispatch(loginUser({ email, password })),
    logout: () => dispatch(logoutUser()),
    updateUser: (userData: Partial<User>) => dispatch(updateUserProfile(userData)),
  };
};

// ä¾¿æ·çš„posts hooks
export const usePosts = () => {
  const dispatch = useAppDispatch();
  const { posts, isLoading, error, hasMore } = useAppSelector(state => state.posts);
  
  return {
    posts,
    isLoading,
    error,
    hasMore,
    fetchPosts: (page?: number) => dispatch(fetchPosts({ page })),
    createPost: (data: any) => dispatch(createPost(data)),
    likePost: (postId: string) => {
      // ä¹è§‚æ›´æ–°
      dispatch(optimisticLike({ postId }));
      // å®é™…APIè°ƒç”¨
      dispatch(togglePostLike(postId));
    },
  };
};
```

#### 7. ç»„ä»¶è¿ç§»ç¤ºä¾‹
```typescript
// åŸContextç‰ˆæœ¬
const CreatePost = () => {
  const { user } = useAuth();
  const { refreshPosts } = usePosts();
  // ...
};

// Reduxç‰ˆæœ¬
const CreatePost = () => {
  const { user } = useAuth(); // ç›¸åŒçš„API
  const { createPost } = usePosts();
  // ...
};
```

### è¿ç§»æ­¥éª¤

1. **é˜¶æ®µ1: è®¾ç½®ReduxåŸºç¡€æ¶æ„**
   - å®‰è£…ä¾èµ–
   - é…ç½®storeå’ŒæŒä¹…åŒ–
   - åˆ›å»ºåŸºç¡€slice

2. **é˜¶æ®µ2: è¿ç§»è®¤è¯æ¨¡å—**
   - åˆ›å»ºauthSlice
   - æ›´æ–°AuthProviderä½¿ç”¨Redux
   - ä¿æŒç›¸åŒçš„hook API

3. **é˜¶æ®µ3: è¿ç§»å¸–å­æ¨¡å—**
   - åˆ›å»ºpostsSlice
   - å®ç°ä¹è§‚æ›´æ–°
   - è¿ç§»ç›¸å…³ç»„ä»¶

4. **é˜¶æ®µ4: è¿ç§»é€šçŸ¥æ¨¡å—**
   - åˆ›å»ºnotificationsSlice
   - å®ç°å®æ—¶æ›´æ–°é€»è¾‘

5. **é˜¶æ®µ5: æ€§èƒ½ä¼˜åŒ–**
   - å®æ–½é€‰æ‹©å™¨ä¼˜åŒ–
   - æ·»åŠ ä¸­é—´ä»¶
   - ä¼˜åŒ–é‡æ–°æ¸²æŸ“

### è¿ç§»çš„ä¼˜åŠ¿

1. **æ›´å¥½çš„è°ƒè¯•ä½“éªŒ**: Redux DevTools
2. **æ€§èƒ½ä¼˜åŒ–**: æ›´ç»†ç²’åº¦çš„çŠ¶æ€æ›´æ–°
3. **å¯é¢„æµ‹æ€§**: æ˜ç¡®çš„çŠ¶æ€å˜æ›´æµç¨‹
4. **æµ‹è¯•å‹å¥½**: æ›´å®¹æ˜“è¿›è¡Œå•å…ƒæµ‹è¯•
5. **æ‰©å±•æ€§**: æ”¯æŒå¤æ‚çš„å¼‚æ­¥é€»è¾‘

---

## ğŸ“š ç»“è®º

ç°æœ‰çš„Contextæ¶æ„å¯¹äºå½“å‰é¡¹ç›®è§„æ¨¡æ˜¯åˆé€‚çš„ï¼Œä½†éšç€åŠŸèƒ½å¤æ‚åº¦çš„å¢é•¿ï¼Œè¿ç§»åˆ°Redux Toolkitå°†å¸¦æ¥æ›´å¥½çš„çŠ¶æ€ç®¡ç†ä½“éªŒã€‚è¿ç§»å¯ä»¥æ¸è¿›å¼è¿›è¡Œï¼Œä¿æŒAPIå…¼å®¹æ€§ï¼Œç¡®ä¿å¹³æ»‘è¿‡æ¸¡ã€‚

é€‰æ‹©å“ªç§æ–¹æ¡ˆä¸»è¦è€ƒè™‘ï¼š
- **é¡¹ç›®è§„æ¨¡å’Œå¤æ‚åº¦**
- **å›¢é˜Ÿç»éªŒå’Œåå¥½**
- **æ€§èƒ½è¦æ±‚**
- **ç»´æŠ¤æˆæœ¬**
- **æœªæ¥æ‰©å±•éœ€æ±‚**

å½“å‰çš„æŠ€æœ¯å®ç°å·²ç»æ¶µç›–äº†ç°ä»£Webåº”ç”¨çš„æ ¸å¿ƒéœ€æ±‚ï¼Œæ— è®ºé€‰æ‹©å“ªç§çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œéƒ½èƒ½å¾ˆå¥½åœ°æ”¯æŒé¡¹ç›®çš„æŒç»­å‘å±•ã€‚
