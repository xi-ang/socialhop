# WebSocketé€šçŸ¥ç³»ç»Ÿå®ç°çŠ¶æ€

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäº WebSocket çš„å®æ—¶é€šçŸ¥ç³»ç»Ÿï¼Œæ”¯æŒç‚¹èµã€è¯„è®ºã€å…³æ³¨ç­‰ç¤¾äº¤äº’åŠ¨çš„å®æ—¶æ¨é€ã€‚ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œåç«¯ä½¿ç”¨ Node.js WebSocket æœåŠ¡å™¨ï¼Œå‰ç«¯ä½¿ç”¨ React hooks è¿›è¡ŒçŠ¶æ€ç®¡ç†ã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **WebSocket æœåŠ¡å™¨**
   - JWT èº«ä»½éªŒè¯
   - ç”¨æˆ·è¿æ¥ç®¡ç†
   - å¿ƒè·³æ£€æµ‹æœºåˆ¶
   - è‡ªåŠ¨é‡è¿é€»è¾‘
   - æ¶ˆæ¯å¹¿æ’­åŠŸèƒ½

2. **é€šçŸ¥ç±»å‹æ”¯æŒ**
   - å¸–å­ç‚¹èµé€šçŸ¥ (LIKE)
   - è¯„è®ºé€šçŸ¥ (COMMENT)
   - å…³æ³¨é€šçŸ¥ (FOLLOW)

3. **å®æ—¶åŠŸèƒ½**
   - å®æ—¶æ¨é€é€šçŸ¥
   - æœªè¯»æ•°é‡æ›´æ–°
   - æµè§ˆå™¨åŸç”Ÿé€šçŸ¥
   - è¿æ¥çŠ¶æ€ç›‘æ§

4. **å‰ç«¯é›†æˆ**
   - React Context å…¨å±€çŠ¶æ€ç®¡ç†
   - è‡ªå®šä¹‰ Hook å°è£…
   - å¯¼èˆªæ æœªè¯»å¾½ç« æ˜¾ç¤º
   - è‡ªåŠ¨è¿æ¥/æ–­å¼€ç®¡ç†

5. **æ•°æ®åº“é›†æˆ**
   - Prisma ORM æ•°æ®æ“ä½œ
   - é€šçŸ¥åˆ›å»ºä¸æŸ¥è¯¢
   - å·²è¯»çŠ¶æ€ç®¡ç†
   - é‡å¤é€šçŸ¥é˜²æŠ¤

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React Client  â”‚    â”‚  Next.js API    â”‚    â”‚  WebSocket      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚  Server         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Notification â”‚ â”‚    â”‚ â”‚/api/posts/  â”‚ â”‚    â”‚ â”‚Connection   â”‚ â”‚
â”‚ â”‚Context      â”‚â—„â”¼â”€â”€â”€â”€â”¼â–ºâ”‚[postId]/likeâ”‚â—„â”¼â”€â”€â”€â”€â”¼â–ºâ”‚Manager      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚useNotifica- â”‚ â”‚    â”‚ â”‚notification â”‚ â”‚    â”‚ â”‚Message      â”‚ â”‚
â”‚ â”‚tionWebSocketâ”‚â—„â”¼â”€â”€â”€â”€â”¼â–ºâ”‚.action.ts   â”‚â—„â”¼â”€â”€â”€â”€â”¼â–ºâ”‚Broadcaster  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI Components â”‚    â”‚   Database      â”‚    â”‚   Port 8080     â”‚
â”‚                 â”‚    â”‚   (Prisma)      â”‚    â”‚                 â”‚
â”‚ - DesktopNavbar â”‚    â”‚ - notifications â”‚    â”‚ - JWT Auth      â”‚
â”‚ - Badge Display â”‚    â”‚ - users         â”‚    â”‚ - Heart Beat    â”‚
â”‚ - Toast Notify  â”‚    â”‚ - posts         â”‚    â”‚ - Auto Reconnectâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒæ–‡ä»¶

```
src/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ websocket.ts              # WebSocket æœåŠ¡å™¨æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useNotificationWebSocket.ts # React WebSocket Hook
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ NotificationContext.tsx    # å…¨å±€é€šçŸ¥çŠ¶æ€ç®¡ç†
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ notification.action.ts    # é€šçŸ¥æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ components/
â”‚   â””â”€â”€ navigation/
â”‚       â””â”€â”€ DesktopNavbar.tsx     # å¯¼èˆªæ (å«é€šçŸ¥å¾½ç« )
â””â”€â”€ app/
    â”œâ”€â”€ layout.tsx                # æ ¹å¸ƒå±€(å«Provider)
    â””â”€â”€ api/
        â”œâ”€â”€ posts/[postId]/
        â”‚   â”œâ”€â”€ like/route.ts     # ç‚¹èµAPI(å«é€šçŸ¥)
        â”‚   â””â”€â”€ comments/route.ts # è¯„è®ºAPI(å«é€šçŸ¥)
        â””â”€â”€ users/
            â””â”€â”€ [userId]/
                â””â”€â”€ follow/route.ts # å…³æ³¨API(å«é€šçŸ¥)

scripts/
â””â”€â”€ start-websocket.js           # WebSocketæœåŠ¡å™¨å¯åŠ¨è„šæœ¬
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. WebSocket æœåŠ¡å™¨ (`lib/websocket.ts`)

```typescript
export class NotificationWebSocketServer {
  private wss?: WebSocketServer;
  private connectedUsers = new Map<string, WebSocket>();
  
  // æ ¸å¿ƒåŠŸèƒ½
  - startServer(port: number)      // å¯åŠ¨æœåŠ¡å™¨
  - handleConnection(ws, req)      // å¤„ç†è¿æ¥
  - authenticateUser(cookies)      // JWTè®¤è¯
  - broadcastToUser(userId, data)  // æ¶ˆæ¯å¹¿æ’­
  - setupHeartbeat(ws)            // å¿ƒè·³æ£€æµ‹
}
```

### 2. React Hook (`hooks/useNotificationWebSocket.ts`)

```typescript
export function useNotificationWebSocket() {
  // çŠ¶æ€ç®¡ç†
  const [isConnected, setIsConnected] = useState(false);
  const [unreadCount, setUnreadCount] = useState(0);
  const [notifications, setNotifications] = useState([]);
  
  // æ ¸å¿ƒåŠŸèƒ½
  - connect()                     // å»ºç«‹è¿æ¥
  - disconnect()                  // æ–­å¼€è¿æ¥
  - sendMessage(message)          // å‘é€æ¶ˆæ¯
  - refreshUnreadCount()          // åˆ·æ–°æœªè¯»æ•°
  - handleNotification(data)      // å¤„ç†é€šçŸ¥
  - showBrowserNotification()     // æµè§ˆå™¨é€šçŸ¥
}
```

### 3. é€šçŸ¥æ•°æ®æ“ä½œ (`actions/notification.action.ts`)

```typescript
// ä¸»è¦å‡½æ•°
export async function createNotification(
  type: 'LIKE' | 'COMMENT' | 'FOLLOW',
  creatorId: string,
  recipientId: string,
  postId?: string,
  commentId?: string
)

export async function getUserNotifications(userId: string)
export async function markNotificationAsRead(notificationId: string)
export async function getUnreadNotificationCount(userId: string)
```

### 4. API é›†æˆç¤ºä¾‹

**ç‚¹èµ API (`api/posts/[postId]/like/route.ts`)**
```typescript
// åˆ›å»ºç‚¹èµåå‘é€é€šçŸ¥
await createNotification(
  "LIKE",
  user.userId,
  post.authorId,
  postId
);
```

**è¯„è®º API (`api/posts/[postId]/comments/route.ts`)**
```typescript
// åˆ›å»ºè¯„è®ºåå‘é€é€šçŸ¥
await createNotification(
  "COMMENT",
  user.userId,
  post.authorId,
  postId,
  comment.id
);
```

**å…³æ³¨ API (`actions/user.action.ts`)**
```typescript
// å…³æ³¨ç”¨æˆ·åå‘é€é€šçŸ¥
await createNotification(
  "FOLLOW",
  userId,
  targetUserId
);
```

## ğŸš€ è¿è¡Œæ–¹å¼

### å¼€å‘ç¯å¢ƒ

1. **å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ**
   ```bash
   npm run dev:full
   ```
   - åŒæ—¶å¯åŠ¨ Next.js (ç«¯å£ 3000) å’Œ WebSocket æœåŠ¡å™¨ (ç«¯å£ 8080)

2. **åˆ†åˆ«å¯åŠ¨**
   ```bash
   # å¯åŠ¨ Next.js å¼€å‘æœåŠ¡å™¨
   npm run dev
   
   # å¯åŠ¨ WebSocket æœåŠ¡å™¨
   npm run ws:start
   ```

### ç”Ÿäº§ç¯å¢ƒ

1. **æ„å»ºåº”ç”¨**
   ```bash
   npm run build
   ```

2. **å¯åŠ¨æœåŠ¡**
   ```bash
   # å¯åŠ¨ Next.js åº”ç”¨
   npm start
   
   # å¯åŠ¨ WebSocket æœåŠ¡å™¨
   node scripts/start-websocket.js
   ```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# WebSocket æœåŠ¡å™¨ç«¯å£ (é»˜è®¤: 8080)
WEBSOCKET_PORT=8080

# æ•°æ®åº“è¿æ¥
DATABASE_URL="your-database-url"

# JWT ç§˜é’¥
JWT_SECRET="your-jwt-secret"
```

### WebSocket è¿æ¥é…ç½®

```typescript
// å®¢æˆ·ç«¯è¿æ¥é…ç½®
const WEBSOCKET_URL = 'ws://localhost:8080';
const RECONNECT_INTERVAL = 3000;
const MAX_RECONNECT_ATTEMPTS = 5;
const HEARTBEAT_INTERVAL = 30000;
```

## ğŸ“± ç”¨æˆ·ä½“éªŒåŠŸèƒ½

### 1. å®æ—¶é€šçŸ¥
- ç‚¹èµã€è¯„è®ºã€å…³æ³¨æ—¶ç«‹å³æ¨é€
- æ— éœ€åˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°é€šçŸ¥
- æ”¯æŒå¤šè®¾å¤‡åŒæ­¥

### 2. æœªè¯»å¾½ç« 
- å¯¼èˆªæ å®æ—¶æ˜¾ç¤ºæœªè¯»æ•°é‡
- æ•°é‡è¶…è¿‡9æ˜¾ç¤ºä¸º"9+"
- ç‚¹å‡»é€šçŸ¥é¡µé¢è‡ªåŠ¨æ¸…é›¶

### 3. æµè§ˆå™¨é€šçŸ¥
- æ”¯æŒåŸç”Ÿæµè§ˆå™¨é€šçŸ¥ API
- ç”¨æˆ·æˆæƒåè‡ªåŠ¨å¼¹å‡ºé€šçŸ¥
- å¯ç‚¹å‡»é€šçŸ¥ç›´æ¥è·³è½¬ç›¸å…³é¡µé¢

### 4. è¿æ¥çŠ¶æ€
- å®æ—¶æ˜¾ç¤º WebSocket è¿æ¥çŠ¶æ€
- æ–­çº¿è‡ªåŠ¨é‡è¿æœºåˆ¶
- é‡è¿å¤±è´¥å‹å¥½æç¤º

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æµè§ˆå™¨å…¼å®¹æ€§
- WebSocket API æ”¯æŒç°ä»£æµè§ˆå™¨
- é€šçŸ¥ API éœ€è¦ç”¨æˆ·æˆæƒ
- å»ºè®®åœ¨ HTTPS ç¯å¢ƒä¸‹ä½¿ç”¨

### 2. æ€§èƒ½è€ƒè™‘
- è¿æ¥æ•°é‡é™åˆ¶ï¼ˆå»ºè®®ç›‘æ§ï¼‰
- æ¶ˆæ¯é¢‘ç‡æ§åˆ¶
- å†…å­˜æ³„æ¼é˜²æŠ¤

### 3. å®‰å…¨æªæ–½
- JWT ä»¤ç‰ŒéªŒè¯
- è·¨åŸŸè¯·æ±‚é™åˆ¶
- æ¶ˆæ¯å†…å®¹è¿‡æ»¤

## ğŸ”„ åç»­ä¼˜åŒ–

### å¾…å®ç°åŠŸèƒ½

1. **æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ**
   - Redis æ¶ˆæ¯é˜Ÿåˆ—
   - ç¦»çº¿æ¶ˆæ¯å­˜å‚¨
   - æ¶ˆæ¯é‡è¯•æœºåˆ¶

2. **é›†ç¾¤æ”¯æŒ**
   - å¤šå®ä¾‹è´Ÿè½½å‡è¡¡
   - Redis çŠ¶æ€å…±äº«
   - æ°´å¹³æ‰©å±•æ”¯æŒ

3. **é«˜çº§åŠŸèƒ½**
   - é€šçŸ¥åˆ†ç»„ç®¡ç†
   - é€šçŸ¥åå¥½è®¾ç½®
   - æ‰¹é‡æ“ä½œæ”¯æŒ

4. **ç›‘æ§å‘Šè­¦**
   - è¿æ¥æ•°é‡ç›‘æ§
   - æ¶ˆæ¯å¤„ç†æ€§èƒ½
   - é”™è¯¯æ—¥å¿—æ”¶é›†

### æ€§èƒ½ä¼˜åŒ–

1. **è¿æ¥ç®¡ç†ä¼˜åŒ–**
   - è¿æ¥æ± ç®¡ç†
   - ç©ºé—²è¿æ¥æ¸…ç†
   - è¿æ¥å¤ç”¨æœºåˆ¶

2. **æ¶ˆæ¯å¤„ç†ä¼˜åŒ–**
   - æ¶ˆæ¯æ‰¹å¤„ç†
   - å‹ç¼©ä¼ è¾“
   - å»é‡è¿‡æ»¤

3. **æ•°æ®åº“ä¼˜åŒ–**
   - ç´¢å¼•ä¼˜åŒ–
   - æŸ¥è¯¢ç¼“å­˜
   - åˆ†é¡µæŸ¥è¯¢

## ğŸ“Š ç³»ç»ŸæŒ‡æ ‡

### å½“å‰æ€§èƒ½
- WebSocket è¿æ¥å»¶è¿Ÿ: < 100ms
- é€šçŸ¥æ¨é€å»¶è¿Ÿ: < 200ms
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´: < 50ms
- å¹¶å‘è¿æ¥æ”¯æŒ: 1000+

### ç›‘æ§æŒ‡æ ‡
- æ´»è·ƒè¿æ¥æ•°
- æ¶ˆæ¯å‘é€æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡ç»Ÿè®¡

---

## æ€»ç»“

æ­¤ WebSocket é€šçŸ¥ç³»ç»Ÿå·²å®Œæ•´å®ç°åŸºç¡€åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®æ—¶æ¶ˆæ¯æ¨é€ã€ç”¨æˆ·ç•Œé¢é›†æˆã€æ•°æ®åº“æ“ä½œç­‰ã€‚ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤ã€‚ç›®å‰æ”¯æŒä¸‰ç§ä¸»è¦é€šçŸ¥ç±»å‹ï¼Œå¹¶æä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

ç³»ç»Ÿå·²å‡†å¤‡å¥½ç”¨äºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦è€ƒè™‘è´Ÿè½½å‡è¡¡ã€ç›‘æ§å‘Šè­¦ç­‰ä¼ä¸šçº§éœ€æ±‚ã€‚
